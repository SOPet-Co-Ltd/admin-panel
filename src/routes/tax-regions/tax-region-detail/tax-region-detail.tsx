import { useState } from 'react';

import { useLoaderData, useParams } from 'react-router-dom';

import { SingleColumnPageSkeleton } from '../../../components/common/skeleton';
import { SingleColumnPage } from '../../../components/layout/pages';
import { useTaxRegion } from '../../../hooks/api/tax-regions';
import { useExtension } from '../../../providers/extension-provider';
import { TaxRegionDetailSection } from './components/tax-region-detail-section';
import { TaxRegionOverrideSection } from './components/tax-region-override-section';
import { TaxRegionProvinceSection } from './components/tax-region-province-section';
import { TaxRegionSublevelAlert } from './components/tax-region-sublevel-alert';
import { taxRegionLoader } from './loader';
import { TaxRegionProviderSection } from './tax-region-provider-section';

export const TaxRegionDetail = () => {
  const { id } = useParams();
  const [showSublevelRegions, setShowSublevelRegions] = useState(false);

  const initialData = useLoaderData() as Awaited<ReturnType<typeof taxRegionLoader>>;

  const {
    tax_region: taxRegion,
    isLoading,
    isError,
    error
  } = useTaxRegion(id!, undefined, { initialData });

  const { getWidgets } = useExtension();

  if (isLoading || !taxRegion) {
    return (
      <SingleColumnPageSkeleton
        sections={4}
        showJSON
      />
    );
  }

  if (isError) {
    throw error;
  }

  return (
    <SingleColumnPage
      data={taxRegion}
      showJSON
      showMetadata
      widgets={{
        after: getWidgets('tax.details.after'),
        before: getWidgets('tax.details.before')
      }}
    >
      <TaxRegionSublevelAlert
        taxRegion={taxRegion}
        showSublevelRegions={showSublevelRegions}
        setShowSublevelRegions={setShowSublevelRegions}
      />
      <TaxRegionDetailSection taxRegion={taxRegion} />
      <TaxRegionProvinceSection
        taxRegion={taxRegion}
        showSublevelRegions={showSublevelRegions}
      />
      <TaxRegionOverrideSection taxRegion={taxRegion} />
      <TaxRegionProviderSection taxRegion={taxRegion} />
    </SingleColumnPage>
  );
};
